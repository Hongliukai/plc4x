//
//  Licensed to the Apache Software Foundation (ASF) under one or more
//  contributor license agreements.  See the NOTICE file distributed with
//  this work for additional information regarding copyright ownership.
//  The ASF licenses this file to You under the Apache License, Version 2.0
//  (the "License"); you may not use this file except in compliance with
//  the License.  You may obtain a copy of the License at
//
//      https://www.apache.org/licenses/LICENSE-2.0
//
//  Unless required by applicable law or agreed to in writing, software
//  distributed under the License is distributed on an "AS IS" BASIS,
//  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//  See the License for the specific language governing permissions and
//  limitations under the License.
//
:imagesdir: ../../images/
:iconsdir: ../../images/users/protocols
:icons: font


//image::integrations/hop/apache_hop_logo.jpg[]

== Apache Hop

image::integrations/apache_hop_logo.jpg[]

== Executive Summary
The integration of the PLC4X communication libraries with Apache Hop, allows having a graphic tool for the acquisition and processing of data from the PLCs or other field devices. With Apache Hop's graphical interface you can orchestrate the transfer of data to files or databases for online or offline storage and processing.

Although there are tools specially designed for this purpose within the foundation, such as Apache NiFi and Apache StreamPipes, Apache Hop has a large number of data transformation blocks that allow them to be differentiated from both projects. It is up to each user to establish which tool meets their particular application.

For the integration of the tools, some creative liberties were taken regarding the internal architecture of Apache Hop, such as having a GlobalContext that can be shared between the "WorkFlow" and the "Pipelines".

The examples that will be presented for the documentation will be oriented to the use of a S7-400/S7-400H controller, typical of the Siemens PCS7 environment, which is our main objective. As the tool is debugged, examples with Modbus and Ethernet/IP will be incorporated.

== Regarding the Support


It is typical within the decision-making cycle in an automation  project to know who and how much the support of the tools that will be  used in the control architecture will cost.

PLC4X support is on our development list (dev@plc4x.apache.org) where we will gladly answer your questions about the S7 driver.

If your company requires commercial support, companies that directly  or indirectly support the drivers and tools developed in PLC4X are  published on our page.

== Record of revisions made to the Hop integration

.Change Log
[cols="1, 2,2a,5a"]
|===
|Rev |Release |Date |Description of the change

|0 |0.10.0 |2023/07/25 |Beta release.
|===

== Development notes

From Hop's preamble we can take:

"Hop aims to be the future of data integration. Visual development enables developers to be more productive than they can be through code. Our Design once, run anywhere workflows and pipelines can be designed in the Hop Gui and run on the Hop native engine (local or remote), or on Spark, Flink, Google Dataflow or AWS EMR through Beam. Lifecycle Management enables developers and administrators to switch between projects, environments and purposes without leaving your train of thought."

Based on these premises, our PLC (AS) will become a data source that can be managed in a workflow or processed in a pipeline.

This will allow us very easily:

. Diagnosis: Captures the states of the controllers in a simple way and allows them to be managed in real time or stored permanently.
. Alarms: The alarms generated directly in the controller (ALARM_8, ALARM_8P).
. Data acquisition: Allows the synchronous or asynchronous capture of data for processing, decision making or historical storage.

In reality, the possibilities are many and will depend directly on the customer's requirement and the availability of these features in the PLCs (AS).

Now, from this point of view our main data source will be our PLC (AS), so it should be shared by all the "workflows" and "pipelines" that are implemented in Apache Hop.

Unlike a standard database, which is designed with a large number of simultaneous client connections, in PLCs (AS) in general, resources are quite limited, even having dedicated communications cards (CP).

This establishes the design premises:

1. Limit the number of connections to be created.
2. Share the connections between the different data flows "worflows" and "pipelines".
3. Limit application execution to one server.

To solve these design points, a GlobalContext based on the Apache NetBeans "Lookup"[1] library and "AbstractReferenceCounted" [2] was implemented.

The first one creates a GlobalContext to store the object reference and the second one creates a wrapper object around the PlcConnection and share it among the different users, keeping an internal account of the users. When this count reaches zero (0), it automatically closes the connection freeing the resource and closes the connection to the controller.

== The Apache Hop documentation

One of the most important aspects of Apache Hop is that it has excellent documentation, a very active developer community that responds quickly and correctly on its development list.

In the attached figure we can see the references to the project page and manuals, specifically:

1. Project address http://hop.apache.org
2. A quick start guide on Apache Hop features
3. A link to the manual where we will find the documentation of the different blocks that are found by default in Hop.

image::integrations/hop/plc4x_hop_001.png[]

In addition to the documentation included in Apache Hop, there are external resources [3] that will be part of the examples available on the web. In the referenced link, there is an example of the use of MQTT as a transport protocol facilitating the integration of Apache Hop with other tools, for example Apache IoTDB.

== Installing Apache PLC4X on Apache Hop

== Integration to Apache Hop



=== Plc4x MetaData

Metadata is a representation of the entry points or data sources, as well as their destination. Represents Apache Hop's iteration with its environment.

.Titulo de la tabla
[cols="1a, 2, 6"]
|===
|Icon |Function |Description

|image::integrations/hop/plc4x_toddy.svg[width=50] |Plc4x Connection |The Mestada provided by Plc4x is the representation of a connection to a PLC (AS) or other device.
|===

When we go to the Metdata menu in the Hop editor, we can add our metadata associated to Plc4x as shown in the attached image following a few simple steps:

1. Add a unique identifier to the connection.
2. Add the connection URL according to the driver to be used.
3. Perform a connection test to the device.

It is important to test the connection to the device, especially if you are deploying the metadata to a Hop server.

image::integrations/hop/plc4x_hop_002.png[]

=== Plc4x Actions

The Actions in a workflow allow validating the environment and resources prior to the execution of a pipeline, which allows minimizing errors during execution in highly dynamic environments. In general, Actions are executed sequentially. The result of its execution is a true or false.

The Actions do not modify the data associated with a Metadata, this should only be done in the transforms within a pipeline.

The following table shows the iconography and function of the Actions implemented by the Apache Plc4x plugins.

[cols="1a, 2, 6"]
|===
|Icon |Function |Description

|image::integrations/hop/plc4x_toddy_play.svg[width=50] |Opens connection to the PLC (AS) |Execute the connection to the PLC. Creates an instance of the connection that can be shared in the execution environment by multiple pipelines.
|image::integrations/hop/plc4x_toddy_stop.svg[width=50] |Close connection to the PLC (AS) |Closes the connection to the PLC, releasing all the associated resources. At this point there should be no other references to the associated connection (for example, pipelines not associated with the workflow)..
|===

If your application requires the pattern "create connection -> execute pipeline -> close connection", we consistently ensure that the connection to the PLC (AS) is closed.

Apache Hop has actions to perform the verification of network devices and resources, it is recommended to verify the existence of the network device, for example by performing a "ping" to later use the rest of the Plc4x actions.


=== Plc4x Transforms

In the transform, it is where the reading, writing or changes of the data to be processed are performed.

Apache Plc4x provides four read, write, subscribe, and event-subscribe transforms, where the last two are implemented only for the Siemens S7-300/S7-400 series.

The following table summarizes the iconography used for the presentation of the plugins, if as a summary of its functionality. Subsequently, the configuration dialogs associated with each transform will be presented.

[cols="1a, 2, 6"]
|===
|Icon |Function | Description

|image::integrations/hop/plc4x_read.svg[width=50]  |Read tags |This transform is responsible for executing the reading of a list of PlcTags.
|image::integrations/hop/plc4x_write.svg[width=50] |Write tags |This transform is in charge of executing the writing of a list of PlcTags.
|image::integrations/hop/plc4x_subs.svg[width=50] |Tags subscriptions |This transform is responsible for executing the subscription to a list of PlcTags synchronously. The minimum scan time is 100 ms. Only applies to S7-300/S7-400.
|image::integrations/hop/plc4x_event.svg[width=50] |Event subscription |This transform is responsible for executing the subscription to system events, user events and process alarms. Only applies to S7-300/S7-400.

|===


[TIP,icon=s7_tip.png]
Each driver developed has its particularities in terms of addressing the PlcTags. Please consult the respective section of the driver documentation for the correct description and basic type associated with each PlcTags.

==== Plc4xRead Transform


==== Plc4x Write Transform

==== Plc4x Subscription Transform

==== Plc4x Event Subscription Transform



== Links

1. https://netbeans.apache.org/wiki/DevFaqLookup.html
2. https://netty.io/4.1/api/io/netty/util/AbstractReferenceCounted.html



